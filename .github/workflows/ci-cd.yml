name: CI/CD Pipeline

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - feature/**
      - develop

jobs:
  # Frontend Checks
  frontend-checks:
    name: Frontend Lint & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify package-lock.json exists
        run: |
          echo "Current directory: $(pwd)"
          echo "Checking for package-lock.json in frontend directory..."
          if [ ! -f "frontend/package-lock.json" ]; then
            echo "❌ package-lock.json not found in frontend directory"
            echo "Files in root:"
            ls -la
            echo "Files in frontend directory:"
            ls -la frontend/ || echo "frontend directory not found"
            exit 1
          else
            echo "✅ package-lock.json found"
            ls -lh frontend/package-lock.json
            echo "File size: $(stat -f%z frontend/package-lock.json 2>/dev/null || stat -c%s frontend/package-lock.json 2>/dev/null) bytes"
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: |
          echo "Installing in: $(pwd)"
          echo "Checking for package-lock.json:"
          ls -lh package-lock.json || echo "❌ package-lock.json not found in current directory"
          npm ci
      
      - name: Run ESLint
        run: npm run lint || true
      
      - name: Build frontend
        run: npm run build
      
      - name: Check build output
        run: |
          if [ ! -d "dist" ]; then
            echo "❌ Build failed - dist directory not found"
            exit 1
          else
            echo "✅ Build successful - dist directory created"
          fi
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 1

  # PR Status Check
  pr-status:
    name: PR Status Check
    runs-on: ubuntu-latest
    needs: frontend-checks
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Check PR status
        run: |
          echo "✅ All checks passed!"
          echo "PR is ready for review and merge to main"
          echo "Branch: ${{ github.head_ref }}"
          echo "PR Number: ${{ github.event.pull_request.number }}"
