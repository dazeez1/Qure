name: CI/CD Pipeline

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - feature/**
      - develop

jobs:
  # Frontend Checks
  frontend-checks:
    name: Frontend Lint & Build
    runs-on: ubuntu-latest
    # This job name will appear in branch protection rules
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify package-lock.json exists
        run: |
          echo "Current directory: $(pwd)"
          echo "Checking for package-lock.json in frontend directory..."
          if [ ! -f "frontend/package-lock.json" ]; then
            echo "❌ package-lock.json not found in frontend directory"
            echo "Files in root:"
            ls -la
            echo "Files in frontend directory:"
            ls -la frontend/ || echo "frontend directory not found"
            exit 1
          else
            echo "✅ package-lock.json found"
            ls -lh frontend/package-lock.json
            echo "File size: $(stat -f%z frontend/package-lock.json 2>/dev/null || stat -c%s frontend/package-lock.json 2>/dev/null) bytes"
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Update npm to latest
        run: npm install -g npm@latest
      
      - name: Verify npm version and package-lock.json
        working-directory: ./frontend
        run: |
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Current directory: $(pwd)"
          echo ""
          echo "Checking package-lock.json:"
          if [ ! -f "package-lock.json" ]; then
            echo "❌ package-lock.json not found"
            exit 1
          fi
          echo "✅ package-lock.json exists"
          ls -lh package-lock.json
          echo ""
          echo "Checking lockfileVersion:"
          lockfile_version=$(node -p "require('./package-lock.json').lockfileVersion")
          echo "Lockfile version: $lockfile_version"
          if [ -z "$lockfile_version" ] || [ "$lockfile_version" = "null" ]; then
            echo "❌ Invalid lockfileVersion"
            exit 1
          fi
          echo "✅ Lockfile version is valid"
      
      - name: Install dependencies
        working-directory: ./frontend
        run: |
          echo "Cleaning node_modules and package-lock.json to fix Rollup optional dependencies issue..."
          rm -rf node_modules package-lock.json
          echo "Installing dependencies with npm install..."
          npm install
          echo "✅ Dependencies installed successfully"
      
      - name: Run ESLint
        working-directory: ./frontend
        run: npm run lint || true
      
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
      
      - name: Check build output
        working-directory: ./frontend
        run: |
          if [ ! -d "dist" ]; then
            echo "❌ Build failed - dist directory not found"
            exit 1
          else
            echo "✅ Build successful - dist directory created"
            ls -lh dist/
          fi
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 1

  # PR Status Check
  pr-status:
    name: PR Status Check
    runs-on: ubuntu-latest
    needs: frontend-checks
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Check PR status
        run: |
          echo "✅ All checks passed!"
          echo "PR is ready for review and merge to main"
          echo "Branch: ${{ github.head_ref }}"
          echo "PR Number: ${{ github.event.pull_request.number }}"
